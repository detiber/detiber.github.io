<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>Properly configuring network devices on a Macchiatobin |</title><meta name=Description content><meta property="og:title" content="Properly configuring network devices on a Macchiatobin"><meta property="og:description" content="I recently broke out as Macchiatobin that I had laying around from a few years ago for testing arm64 support with Tinkerbell. I started with getting an updated version of EDK2 running on it. Followed by getting an updated version of mainline u-boot running on it. It was during the process of running a newer version of u-boot that I realized I never properly configured this board after getting it."><meta property="og:type" content="article"><meta property="og:url" content="http://detiber.github.io/posts/macchiatobin_network/"><meta property="article:published_time" content="2021-02-11T14:27:00-05:00"><meta property="article:modified_time" content="2021-02-11T14:27:00-05:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Properly configuring network devices on a Macchiatobin"><meta name=twitter:description content="I recently broke out as Macchiatobin that I had laying around from a few years ago for testing arm64 support with Tinkerbell. I started with getting an updated version of EDK2 running on it. Followed by getting an updated version of mainline u-boot running on it. It was during the process of running a newer version of u-boot that I realized I never properly configured this board after getting it."><meta name=application-name content="Jason DeTiberus"><meta name=apple-mobile-web-app-title content="Jason DeTiberus"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=manifest href=/site.webmanifest><link rel=canonical href=http://detiber.github.io/posts/macchiatobin_network/><link rel=prev href=http://detiber.github.io/posts/macchiatobin_uboot/><link rel=stylesheet href=/lib/normalize/normalize.min.css><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=/lib/fontawesome-free/all.min.css><link rel=stylesheet href=/lib/animate/animate.min.css><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Properly configuring network devices on a Macchiatobin","inLanguage":"en-us","mainEntityOfPage":{"@type":"WebPage","@id":"http:\/\/detiber.github.io\/posts\/macchiatobin_network\/"},"genre":"posts","keywords":"ARM, Macchiatobin","wordCount":631,"url":"http:\/\/detiber.github.io\/posts\/macchiatobin_network\/","datePublished":"2021-02-11T14:27:00-05:00","dateModified":"2021-02-11T14:27:00-05:00","publisher":{"@type":"Organization","name":""},"description":""}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"","item":"http:\/\/detiber.github.io\/"},{"@type":"ListItem","position":2,"name":"Tinkerbell","item":"http://detiber.github.io/categories/tinkerbell/"},{"@type":"ListItem","position":3,"name":"Properly configuring network devices on a Macchiatobin"}]}</script></head><body data-header-desktop data-header-mobile><script>(window.localStorage&&localStorage.getItem('theme')?localStorage.getItem('theme')==='dark':('auto'==='auto'?window.matchMedia('(prefers-color-scheme: dark)').matches:'auto'==='dark'))&&document.body.setAttribute('theme','dark');</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title="Jason DeTiberus" class=header-logo>Jason DeTiberus</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/>Posts </a><a class=menu-item href=/tags/>Tags </a><a class=menu-item href=/categories/>Categories </a><span class="menu-item delimiter"></span><a href=javascript:void(0); class="menu-item theme-switch"><i class="fas fa-adjust fa-fw"></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="Jason DeTiberus" class=header-logo>Jason DeTiberus</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><a class=menu-item href=/posts/>Posts</a><a class=menu-item href=/tags/>Tags</a><a class=menu-item href=/categories/>Categories</a><a href=javascript:void(0); class="menu-item theme-switch">
<i class="fas fa-adjust fa-fw"></i></a></div></div></header><main class=main><div class="container content-article theme-classic"><div class=toc id=toc-auto><div class=toc-title></div><div class=toc-content id=toc-content-auto></div></div><div class=header-post><div class=post-title><div class=post-all-meta><div class=breadcrumbs><a href=/></a>/ <a href=/categories/tinkerbell/>Tinkerbell </a>/ <a href=/>Properly configuring network devices on a Macchiatobin</a></div><h1 class="single-title animated flipInX">Properly configuring network devices on a Macchiatobin</h1><div class=post-meta><div class=post-meta-line><span class=post-category><a href=/categories/tinkerbell/><i class="far fa-folder fa-fw"></i>&nbsp;Tinkerbell</a>&nbsp;<a href=/categories/hardware/><i class="far fa-folder fa-fw"></i>&nbsp;Hardware</a>
</span>&nbsp;&nbsp;&nbsp;&nbsp;<i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time class=timeago datetime=2021-02-11>2021-02-11</time>&nbsp;&nbsp;&nbsp;&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;<i class="far fa-clock fa-fw"></i>&nbsp;</div></div></div></div></div><article class="single toc-start"><div class="content-block content-block-first content-block-position"><div class=post><div class="details toc" id=toc-static data-kept><div class="details-summary toc-title"><span></span><span><i class="details-icon fas fa-angle-right"></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents></nav></div></div><p>I recently broke out as Macchiatobin that I had laying around from a few years ago for testing arm64 support with <a href=https://tinkerbell.org target=_blank rel="noopener noreffer">Tinkerbell</a>. I started with getting an <a href=http://detiber.github.io/posts/macchiatobin_uefi/ rel>updated version of EDK2 running on it.</a> Followed by getting an updated version of <a href=http://detiber.github.io/posts/macchiatobin_uefi/ rel>mainline u-boot running on it</a>. It was during the process of running a newer version of u-boot that I realized I never properly configured this board after getting it.</p><p><a href=https://www.denx.de/wiki/view/DULG/UBootPowerOn>https://www.denx.de/wiki/view/DULG/UBootPowerOn</a> made me realize that I needed to configure the network MAC addresses after installing a new version of u-boot, so I thought I would dump the variables from the original u-boot image on the SPI ROM before doing just that.</p><div class=highlight><pre class=chroma><code class=language-sh data-lang=sh>mv_ddr: completed successfully
NOTICE:  Cold boot
NOTICE:  Booting Trusted Firmware
NOTICE:  BL1: v1.3<span class=o>(</span>release<span class=o>)</span>:armada-17.10.3:4af6d73
NOTICE:  BL1: Built : 13:40:06, Oct <span class=m>15</span> <span class=m>2017</span>
NOTICE:  BL1: Booting BL2
lNOTICE:  BL2: v1.3<span class=o>(</span>release<span class=o>)</span>:armada-17.10.3:4af6d73
NOTICE:  BL2: Built : 13:40:06, Oct <span class=m>15</span> <span class=m>2017</span>
NOTICE:  BL1: Booting BL31
lNOTICE:  MSS PM is not supported in this build
NOTICE:  BL31: v1.3<span class=o>(</span>release<span class=o>)</span>:armada-17.10.3:4af6d73
NOTICE:  BL31: Built : 13:40:07, Oct <span class=m>15</span> <span class=m>2017</span>
l

U-Boot 2017.03-armada-17.10.1 <span class=o>(</span>Oct <span class=m>15</span> <span class=m>2017</span> - 14:03:12 +0300<span class=o>)</span>

Model: MACCHIATOBin-8040
Clock:  CPU     <span class=m>2000</span> <span class=o>[</span>MHz<span class=o>]</span>
        DDR     <span class=m>1050</span> <span class=o>[</span>MHz<span class=o>]</span>
        FABRIC  <span class=m>1050</span> <span class=o>[</span>MHz<span class=o>]</span>
        MSS     <span class=m>200</span>  <span class=o>[</span>MHz<span class=o>]</span>
DRAM:  <span class=m>16</span> GiB
U-Boot DT blob at : 000000007f70fc38
EEPROM configuration pattern not detected.
Comphy chip <span class=c1>#0:</span>
Comphy-0: PEX0         
Comphy-1: PEX0         
Comphy-2: PEX0         
Comphy-3: PEX0         
Comphy-4: SFI          
Comphy-5: SATA1        
Comphy chip <span class=c1>#1:</span>
Comphy-0: SGMII1        1.25 Gbps 
Comphy-1: SATA0        
Comphy-2: USB3_HOST0   
Comphy-3: SATA1        
Comphy-4: SFI          
Comphy-5: SGMII2        3.125 Gbps
UTMI PHY <span class=m>0</span> initialized to USB Host0
SATA link <span class=m>0</span> timeout.
SATA link <span class=m>1</span> timeout.
AHCI 0001.0000 <span class=m>32</span> slots <span class=m>2</span> ports <span class=m>6</span> Gbps 0x3 impl SATA mode
flags: 64bit ncq led only pmp fbss pio slum part sxs 
Target spinup took <span class=m>0</span> ms.
SATA link <span class=m>1</span> timeout.
AHCI 0001.0000 <span class=m>32</span> slots <span class=m>2</span> ports <span class=m>6</span> Gbps 0x3 impl SATA mode
flags: 64bit ncq led only pmp fbss pio slum part sxs 
PCIE-0: Link down
MMC:   sdhci@6e0000: 0, sdhci@780000: <span class=m>1</span>
SF: Detected w25q32bv with page size <span class=m>256</span> Bytes, erase size <span class=m>4</span> KiB, total <span class=m>4</span> MiB
Net:   eth0: mvpp2-0 <span class=o>[</span>PRIME<span class=o>]</span>mdio_register: non unique device name <span class=s1>&#39;ethernet@0&#39;</span>
, eth1: mvpp2-3, eth2: mvpp2-4, eth3: mvpp2-5
Hit any key to stop autoboot:  <span class=m>0</span> 
Marvell&gt;&gt; env print
<span class=nv>baudrate</span><span class=o>=</span><span class=m>115200</span>
<span class=nv>bootargs</span><span class=o>=</span><span class=nv>console</span><span class=o>=</span>ttyS0,115200 <span class=nv>root</span><span class=o>=</span>/dev/mmcblk1p1 rw rootwait
<span class=nv>bootcmd</span><span class=o>=</span>run get_env<span class=p>;</span> run get_images<span class=p>;</span> run set_bootargs<span class=p>;</span> booti <span class=nv>$kernel_addr</span> <span class=nv>$ramfs_addr</span> <span class=nv>$fdt_addr</span>
<span class=nv>bootdelay</span><span class=o>=</span><span class=m>2</span>
<span class=nv>bootmmc</span><span class=o>=</span>mmc dev 1<span class=p>;</span> ext4load mmc 1:1 <span class=nv>$kernel_addr</span> <span class=nv>$image_name</span><span class=p>;</span>ext4load mmc 1:1 <span class=nv>$fdt_addr</span> <span class=nv>$fdt_name</span><span class=p>;</span>setenv bootargs <span class=nv>$console</span> <span class=nv>root</span><span class=o>=</span>/dev/mmcblk1p1 rw rootwait<span class=p>;</span> booti <span class=nv>$kerner</span>
<span class=nv>console</span><span class=o>=</span><span class=nv>console</span><span class=o>=</span>ttyS0,115200
<span class=nv>eth1addr</span><span class=o>=</span>00:51:82:11:22:01
<span class=nv>eth2addr</span><span class=o>=</span>00:51:82:11:22:02
<span class=nv>eth3addr</span><span class=o>=</span>00:51:82:11:22:03
<span class=nv>ethact</span><span class=o>=</span>mvpp2-0
<span class=nv>ethaddr</span><span class=o>=</span>00:51:82:11:22:00
<span class=nv>ethprime</span><span class=o>=</span>eth0
<span class=nv>fdt_addr</span><span class=o>=</span>0x4f00000
<span class=nv>fdt_high</span><span class=o>=</span>0xffffffffffffffff
<span class=nv>fdt_name</span><span class=o>=</span>boot/armada-8040-mcbin.dtb
<span class=nv>fdtcontroladdr</span><span class=o>=</span>7f70fc38
<span class=nv>fileaddr</span><span class=o>=</span><span class=m>5000000</span>
<span class=nv>filesize</span><span class=o>=</span>c2e600
<span class=nv>ftd_name</span><span class=o>=</span>boot/armada-8040-mcbin.dtb
<span class=nv>gatewayip</span><span class=o>=</span>10.4.50.254                                                                               
<span class=nv>get_env</span><span class=o>=</span>mw 0x01700000 <span class=m>0</span> 0x1000<span class=p>;</span> fatload mmc 1:1 0x01700000 /uenv.txt<span class=p>;</span> <span class=k>if</span> <span class=nb>test</span> <span class=s2>&#34;</span><span class=nv>$?</span><span class=s2>&#34;</span> <span class=o>=</span> <span class=s2>&#34;0&#34;</span><span class=p>;</span> <span class=k>then</span> env import -t 0x01700000<span class=p>;</span> <span class=k>else</span> ext4load mmc 1:1 0x01700000 /uenv.txt<span class=p>;</span> <span class=k>if</span> i
<span class=nv>get_images</span><span class=o>=</span>tftpboot <span class=nv>$kernel_addr</span> <span class=nv>$image_name</span><span class=p>;</span> tftpboot <span class=nv>$fdt_addr</span> <span class=nv>$fdt_name</span><span class=p>;</span> run get_ramfs           
<span class=nv>get_ramfs</span><span class=o>=</span><span class=k>if</span> <span class=nb>test</span> <span class=s2>&#34;</span><span class=si>${</span><span class=nv>ramfs_name</span><span class=si>}</span><span class=s2>&#34;</span> !<span class=o>=</span> <span class=s2>&#34;-&#34;</span><span class=p>;</span> <span class=k>then</span> setenv ramfs_addr 0x8000000<span class=p>;</span> tftpboot <span class=nv>$ramfs_addr</span> <span class=nv>$ramfs_name</span><span class=p>;</span> <span class=k>else</span> setenv ramfs_addr -<span class=p>;</span><span class=k>fi</span>
<span class=nv>hostname</span><span class=o>=</span>marvell                                                                                    
<span class=nv>image_name</span><span class=o>=</span>boot/Image
<span class=nv>initrd_addr</span><span class=o>=</span>0xa00000
<span class=nv>initrd_size</span><span class=o>=</span>0x2000000
<span class=nv>ipaddr</span><span class=o>=</span>0.0.0.0
<span class=nv>kernel_addr</span><span class=o>=</span>0x5000000
<span class=nv>loadaddr</span><span class=o>=</span>0x5000000
<span class=nv>netdev</span><span class=o>=</span>eth0
<span class=nv>netmask</span><span class=o>=</span>255.255.255.0
<span class=nv>ramfs_addr</span><span class=o>=</span>-
<span class=nv>ramfs_name</span><span class=o>=</span>-
<span class=nv>root</span><span class=o>=</span><span class=nv>root</span><span class=o>=</span>/dev/nfs rw
<span class=nv>rootpath</span><span class=o>=</span>/srv/nfs/
<span class=nv>serverip</span><span class=o>=</span>0.0.0.0
<span class=nv>set_bootargs</span><span class=o>=</span>setenv bootargs <span class=nv>$console</span> <span class=nv>$root</span> <span class=nv>ip</span><span class=o>=</span><span class=nv>$ipaddr</span>:<span class=nv>$serverip</span>:<span class=nv>$gatewayip</span>:<span class=nv>$netmask</span>:<span class=nv>$hostname</span>:<span class=nv>$netdev</span>:none <span class=nv>nfsroot</span><span class=o>=</span><span class=nv>$serverip</span>:<span class=nv>$rootpath</span> <span class=nv>$extra_params</span>
<span class=nv>stderr</span><span class=o>=</span>serial@512000
<span class=nv>stdin</span><span class=o>=</span>serial@512000
<span class=nv>stdout</span><span class=o>=</span>serial@512000

Environment size: 2193/65532 bytes
</code></pre></div><p>Digging into more u-boot documentation, I found
<a href=https://gitlab.denx.de/u-boot/u-boot/-/blob/c7182c02cefb11431a79a8abb4d8a821e4a478b5/doc/README.marvell,>https://gitlab.denx.de/u-boot/u-boot/-/blob/c7182c02cefb11431a79a8abb4d8a821e4a478b5/doc/README.marvell,</a> which points out that the MAC addresses configured for the u-boot in SPI where hardcoded defaults. Looks like it&rsquo;s time to boot back into the updated u-boot from my SDCard and set these to some better values.</p><p>To try and avoid any potential conflicts with real hardware, I need to create some Unicast Local MAC addresses. More info on MAC Addresses <a href=https://en.wikipedia.org/wiki/MAC_address target=_blank rel="noopener noreffer">here</a>, but basically I need to ensure that the second least significant bit of the first octet is 1 and the least significant bit of the first octet is 0.</p><p>Since I&rsquo;m going to use this for demos, and having something memorable and recognizable will help, I decided to use beðŸ‡©ðŸ‡ªad:be:ef:00 through beðŸ‡©ðŸ‡ªad:be:ef:03 as the MAC addresses.</p><div class=highlight><pre class=chroma><code class=language-sh data-lang=sh>setenv ethaddr beðŸ‡©ðŸ‡ªad:be:ef:00
setenv eth1addr beðŸ‡©ðŸ‡ªad:be:ef:01
setenv eth2addr beðŸ‡©ðŸ‡ªad:be:ef:02
setenv eth3addr beðŸ‡©ðŸ‡ªad:be:ef:03
saveenv
</code></pre></div></div><div class=post><div class=post-info-share><span></span></div><div class=post-footer id=post-footer><div class=post-navigation><div class="post-nav-box nav-box-prev"><a class=nav-box href=/posts/macchiatobin_uboot/><span class=nav-icon><svg aria-hidden="true" data-prefix="fas" data-icon="chevron-circle-left" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M256 504C119 504 8 393 8 256S119 8 256 8s248 111 248 248-111 248-248 248zM142.1 273l135.5 135.5c9.4 9.4 24.6 9.4 33.9.0l17-17c9.4-9.4 9.4-24.6.0-33.9L226.9 256l101.6-101.6c9.4-9.4 9.4-24.6.0-33.9l-17-17c-9.4-9.4-24.6-9.4-33.9.0L142.1 239c-9.4 9.4-9.4 24.6.0 34z"/></svg></span><div style=text-align:right;padding-left:10px><div class=nav-text-h></div><span class=nav-text>Current u-boot on a Macchiatobin</span></div></a></div></div></div></div></div><div id=toc-final></div></article><div class="post-tags post-tags-toc"><a href=/tags/arm/ class=tag>ARM</a><a href=/tags/macchiatobin/ class=tag>Macchiatobin</a></div><div class="page single comments content-block-position"><div id=comments><div id=disqus_thread class=comment></div><noscript>Please enable JavaScript to view the comments powered by <a href=https://disqus.com/?ref_noscript>Disqus</a>.</noscript></div></div></div></main><footer class=footer><div class=footer-container><div class=footer-line></div><div class=footer-line><i class="far fa-copyright fa-fw"></i><span>2021</span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-sa/4.0 target=_blank>CC BY-SA 4.0</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button><i class="fas fa-arrow-up fa-fw"></i></a><a href=# id=view-comments class=fixed-button><i class="fas fa-comment fa-fw"></i></a></div><script src=https://detiber.disqus.com/embed.js defer></script><script src=/lib/smooth-scroll/smooth-scroll.min.js></script><script src=/lib/lazysizes/lazysizes.min.js></script><script src=/lib/clipboard/clipboard.min.js></script><script>window.config={"code":{"copyTitle":"","maxShownLines":10},"comment":{}};</script><script src=/js/theme.min.js></script><script src=/js/jquery-3.5.1.min.js></script></body></html>